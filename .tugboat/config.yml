services:

  php:
    image: tugboatqa/php:7-apache
    default: true
    depends: mysql
    commands:
      init:
        - set -x
        - apt-get update
        - apt-get install -y libzip-dev mysql-client
        - pecl install zip
        - docker-php-ext-enable zip
        - mkdir "${TUGBOAT_ROOT}/craft"
        - composer create-project craftcms/craft "${TUGBOAT_ROOT}/craft"
        - ln -snf "${TUGBOAT_ROOT}/craft/web" "${DOCROOT}"
      
      update:
        - ${TUGBOAT_ROOT}/craft/craft setup/security-key
        - ${TUGBOAT_ROOT}/craft/craft setup/db-creds --interactive=0 --database=tugboat --user=tugboat --password=tugboat --server=mysql
        - ${TUGBOAT_ROOT}/craft/craft install --interactive=0 --email="${CRAFT_EMAIL}" --username=tugboat --password=${CRAFT_PWD} --siteName="${TUGBOAT_PROJECT}"
        - chgrp -R www-data "${TUGBOAT_ROOT}/craft/config/"
        - chgrp -R www-data "${TUGBOAT_ROOT}/craft/storage/"
        - chmod -R 774 "${TUGBOAT_ROOT}/craft/config/"
        - chmod -R 774 "${TUGBOAT_ROOT}/craft/storage/"

 
  mysql:
    image: tugboatqa/mysql:5
    commands:
      init: 
      - set -x
      
